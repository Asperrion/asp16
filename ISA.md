# asp-16 ISA v1.1

Учебно-ретро 16-битный процессор с простым фиксированным форматом инструкций и собственным ассемблером.

---

## Общая информация

- Разрядность: **16 бит**
- Адресное пространство: **64 КБ** (`0x0000–0xFFFF`)
- Endianness: **Little-endian**
- Фиксированный размер инструкции: **4 байта**
- Архитектура: register-based
- Поддержка подпрограмм и стека
- Memory-mapped I/O

---

## Регистры

| Регистр | Назначение            |
|-------|------------------------|
| AX    | аккумулятор            |
| BX    | регистр общего назначения |
| CX    | регистр общего назначения |
| DX    | регистр общего назначения |
| SP    | указатель стека        |
| IP    | указатель инструкции   |
| FLAGS | регистр флагов         |

---

## FLAGS

| Бит | Имя | Описание |
|----|-----|----------|
| 0  | ZF  | Zero Flag (результат = 0) |
| 1  | CF  | Carry Flag (переполнение) |

---

## Формат инструкции

Каждая инструкция занимает **ровно 4 байта**:

```

[ OPCODE ][ OP1 ][ OP2 ][ OP3 ]

```

Неиспользуемые операнды должны быть равны `0`.

---

## Адресация и BIOS

- Адреса `0x0000–0x0FFF` — BIOS
- Пользовательская программа загружается по адресу **`0x1000`**
- Все переходы (`CALL`, `JMP`) используют **смещение относительно `0x1000`**
- После загрузки BIOS устанавливает `IP = 0x1000`

---

## Инструкции

### NOP — No Operation

```

OP_NOP, 0, 0, 0

```

---

### MOV — перемещение данных

#### MOV reg, imm8

```

OP_MOV_IMM, REG, 0, IMM8

````

Пример:
```asm
mov ax, 42
````

---

#### MOV reg, reg

```
OP_MOV_REG, REG_DST, REG_SRC, 0
```

---

### ADD — сложение

```
OP_ADD, REG_DST, REG_SRC, 0
```

* `REG_DST = REG_DST + REG_SRC`
* Обновляет `ZF` и `CF`

---

### LOAD — загрузка из памяти

```
OP_LOAD, REG, ADDR_LO, ADDR_HI
```

Загружает 16-битное значение из памяти в регистр.

---

### STORE — запись в память / I/O

```
OP_STORE, REG, ADDR_LO, ADDR_HI
```

Записывает значение регистра в память.

#### Memory-mapped I/O

| Адрес    | Назначение                          |
| -------- | ----------------------------------- |
| `0xFF00` | вывод символа (ASCII, младший байт) |
| `0xFF02` | вывод числа (16-бит, decimal)       |

Пример:

```asm
mov ax, 72
store ax, 0xFF00   ; вывод 'H'
```

---

### PUSH — поместить в стек

```
OP_PUSH, REG, 0, 0
```

---

### POP — извлечь из стека

```
OP_POP, REG, 0, 0
```

---

### CALL — вызов подпрограммы

```
OP_CALL, ADDR_LO, ADDR_HI, 0
```

* Сохраняет `IP` в стек
* Переходит на `0x1000 + ADDR`

---

### RET — возврат из подпрограммы

```
OP_RET, 0, 0, 0
```

* Извлекает `IP` из стека

---

### JMP — безусловный переход

```
OP_JMP, ADDR_LO, ADDR_HI, 0
```

---

### HLT — остановка процессора

```
OP_HLT, 0, 0, 0
```

---

## Стек

* Стек растёт **вниз**
* `SP` указывает на вершину стека
* `PUSH`: `SP -= 2`
* `POP`:  `SP += 2`

---

## Ассемблер (.asmp)

### Комментарии

```asm
; это комментарий
```

---

### Метки

```asm
start:
    mov ax, 5
    call double
    hlt

double:
    add ax, ax
    ret
```

---

### Числа

Поддерживаются:

* десятичные: `42`
* шестнадцатеричные: `0x2A`

---

## Пример программы

```asm
mov ax, 72
store ax, 0xFF00

mov ax, 101
store ax, 0xFF00

mov ax, 108
store ax, 0xFF00

mov ax, 108
store ax, 0xFF00

mov ax, 111
store ax, 0xFF00

mov ax, 10
store ax, 0xFF00

mov ax, 1337
store ax, 0xFF02

hlt
```